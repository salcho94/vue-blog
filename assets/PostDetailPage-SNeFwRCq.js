import{s as q,x as $,y as z,z as F,A as K,B as O,C as U,D as G,E as N,G as J,d as Q,H as W,I as X,r as m,c as _,l as Y,w as M,o as Z,b as n,g as y,t as c,e as a,J as ee,k as te,i as P,u as h,R as se,F as D,h as L,f as ae,v as le,K as oe,L as re,M as ne,q as r,N as B,O as ie,P as ue}from"./index-CiPrqIqM.js";import{M as de}from"./index-BMSQkwth.js";const S=K(N,"comments");async function ce(x){await q(S,{...x,createdAt:J()})}async function w(x){const i=$(S,F("postId","==",x),z("createdAt","asc"));return(await O(i)).docs.map(f=>({id:f.id,...f.data()}))}async function ve(x){await U(G(N,"comments",x))}const me={class:"max-w-3xl mx-auto space-y-4"},xe={key:0,class:"text-xs text-slate-500"},pe={key:1,class:"text-xs text-red-400"},ye={key:2,class:"space-y-5"},fe={class:"flex items-start justify-between gap-3"},ge={class:"flex-1 space-y-1"},ke={class:"text-2xl font-semibold text-slate-900 dark:text-slate-100"},he={class:"flex flex-wrap items-center justify-end gap-2 text-[11px] text-slate-500"},be=["disabled","title"],_e={class:"text-xs"},we={class:"prose prose-sm max-w-none dark:prose-invert text-slate-800 dark:text-slate-100 bg-slate-50 dark:bg-slate-900/90 rounded-2xl p-4"},Ce=["innerHTML"],Ie={key:0,class:"flex flex-wrap gap-2 mt-3"},Me={class:"space-y-3"},Pe={class:"text-sm font-medium text-slate-800 dark:text-slate-100 flex items-center gap-2"},De={class:"text-[10px] text-slate-500"},Le={key:0,class:"flex gap-2 items-start"},Be={key:1,class:"text-[11px] text-slate-500"},Ne={key:2,class:"space-y-1.5"},Se={class:"space-y-0.5"},Ae={class:"font-medium text-slate-700 dark:text-slate-300"},Te={class:"text-slate-700 dark:text-slate-100"},Ve=["onClick"],Ee={key:3,class:"text-[11px] text-slate-500"},qe=Q({__name:"PostDetailPage",setup(x){const i=W(),C=Y(),f=re(),l=X(),t=m(null),u=m([]),b=m(!0),p=m(""),g=m(""),d=m(!1),k=m(!1),v=_(()=>C.params.id),A=new de({breaks:!0}),T=_(()=>t.value?A.render(t.value.content):"");async function V(e){if(!e){p.value="잘못된 포스트 ID입니다.",t.value=null,u.value=[],d.value=!1;return}b.value=!0,p.value="";try{const o=await ie(e);if(!o){p.value="포스트를 찾을 수 없습니다.",t.value=null,u.value=[],d.value=!1;return}t.value={...o,category:o.category||"여행"};const s=`viewed_post_${e}`;sessionStorage.getItem(s)||ue(e).then(()=>{sessionStorage.setItem(s,"1")}).catch(()=>{}),u.value=await w(e),l.user?d.value=await B(e,l.user.uid):d.value=!1}catch(o){p.value=o?.message||"불러오기 실패",t.value=null,u.value=[],d.value=!1}finally{b.value=!1}}M(v,e=>{e&&V(e)},{immediate:!0}),M(()=>l.user?.uid,async e=>{t.value&&(d.value=e?await B(v.value,e):!1)}),Z(()=>{l.init?.()});const I=_(()=>!!(l.user&&t.value&&l.user.uid===t.value.authorId));async function E(){if(!l.user){i.alert({title:"로그인 필요",message:"댓글을 작성하려면 로그인하세요.",type:"info"});return}const e=g.value.trim();if(!(!e||!v.value))try{await ce({postId:v.value,authorId:l.user.uid,authorName:l.user.email||"user",content:e}),g.value="",u.value=await w(v.value)}catch(o){i.alert({title:"댓글 등록 실패",message:o?.message||"댓글 등록 중 오류가 발생했습니다.",type:"error"})}}async function H(e,o){if(!(!l.user||l.user.uid!==o))try{i.confirm({title:"해당 댓글을 삭제할까요?",message:"삭제 후에는 되돌릴 수 없습니다.",type:"error",onConfirm:async()=>{try{await ve(e),v.value&&(u.value=await w(v.value))}catch(s){i.alert({title:"댓글 삭제 실패",message:s?.message||"삭제 중 오류가 발생했습니다.",type:"error"})}}})}catch(s){i.alert({title:"댓글 삭제 실패",message:s?.message||"댓글 삭제 중 오류가 발생했습니다.",type:"error"})}}async function R(){t.value&&i.confirm({title:"이 글을 삭제할까요?",message:"삭제 후에는 되돌릴 수 없습니다.",type:"error",onConfirm:async()=>{try{await oe(t.value.id),window.dispatchEvent(new CustomEvent("posts-updated")),f.push("/")}catch(e){i.alert({title:"삭제 실패",message:e?.message||"삭제 중 오류가 발생했습니다.",type:"error"})}}})}async function j(){if(t.value){if(!l.user){i.alert({title:"비회원",message:"로그인이 필요합니다!",type:"info"});return}if(!k.value){k.value=!0;try{const e=await ne(t.value.id,l.user.uid);d.value=e.liked,t.value&&(t.value.likes=e.likes)}catch(e){i.alert({title:"좋아요 오류",message:e?.message||"좋아요 처리 중 오류가 발생했습니다.",type:"error"})}finally{k.value=!1}}}}return(e,o)=>(r(),n("div",me,[b.value?(r(),n("div",xe,"loading...")):p.value?(r(),n("div",pe,c(p.value),1)):t.value?(r(),n("div",ye,[a("div",fe,[a("div",ge,[a("h1",ke,c(t.value.title),1)]),a("div",he,[a("span",null,c(t.value.views??0)+" views",1),a("button",{onClick:j,disabled:k.value,class:"inline-flex items-center gap-1 px-2 py-1 rounded-md border border-slate-300/80 dark:border-slate-600/80 bg-white/90 dark:bg-slate-900/80 hover:border-cyan-400 hover:text-cyan-300 disabled:opacity-60 disabled:cursor-not-allowed transition-colors",title:d.value?"좋아요 취소":"좋아요"},[a("span",_e,c(d.value?"★":"☆"),1),a("span",null,c(t.value.likes??0),1)],8,be),I.value?(r(),ee(h(se),{key:0,to:`/admin/edit/${t.value.id}`,class:"px-2 py-1 rounded-md bg-slate-900 text-slate-100 hover:bg-black dark:bg-yellow-400 dark:text-black dark:hover:bg-yellow-300 transition-colors"},{default:te(()=>[...o[1]||(o[1]=[P(" 수정 ",-1)])]),_:1},8,["to"])):y("",!0),I.value?(r(),n("button",{key:1,onClick:R,class:"px-2 py-1 rounded-md bg-red-500 text-white hover:bg-red-400 transition-colors"}," 삭제 ")):y("",!0)])]),a("article",we,[a("div",{innerHTML:T.value},null,8,Ce)]),t.value.tags&&t.value.tags.length?(r(),n("div",Ie,[(r(!0),n(D,null,L(t.value.tags,s=>(r(),n("span",{key:s,class:"px-2 py-1 rounded-md text-[11px] bg-slate-100 dark:bg-slate-900/70 text-slate-700 dark:text-slate-200 border border-transparent hover:border-black dark:hover:border-yellow-400 cursor-default select-none transition"}," #"+c(s),1))),128))])):y("",!0),a("section",Me,[a("h2",Pe,[o[2]||(o[2]=P(" comments ",-1)),a("span",De,"("+c(u.value.length)+")",1)]),h(l).user?(r(),n("div",Le,[ae(a("textarea",{"onUpdate:modelValue":o[0]||(o[0]=s=>g.value=s),rows:"2",class:"flex-1 rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 px-2 py-1.5 text-[12px] text-slate-800 dark:text-slate-100 resize-none focus:outline-none focus:ring-1 focus:ring-black dark:focus:ring-yellow-400",placeholder:"댓글을 입력하세요"},null,512),[[le,g.value]]),a("button",{onClick:E,class:"px-3 py-1.5 rounded-md text-[11px] font-semibold bg-black text-white hover:bg-slate-800 dark:bg-yellow-400 dark:text-black dark:hover:bg-yellow-300 transition-colors"}," 등록 ")])):(r(),n("div",Be," 댓글을 작성하려면 로그인하세요. ")),u.value.length?(r(),n("div",Ne,[(r(!0),n(D,null,L(u.value,s=>(r(),n("div",{key:s.id,class:"flex items-start justify-between gap-2 rounded-md bg-slate-100 dark:bg-slate-900/80 px-2 py-1.5 text-[11px]"},[a("div",Se,[a("div",Ae,c(s.authorName||"user"),1),a("div",Te,c(s.content),1)]),h(l).user&&h(l).user.uid===s.authorId?(r(),n("button",{key:0,onClick:He=>H(s.id,s.authorId),class:"mt-1 text-[10px] text-red-400 hover:text-red-300"}," 삭제 ",8,Ve)):y("",!0)]))),128))])):(r(),n("div",Ee," 아직 댓글이 없습니다. "))])])):y("",!0)]))}});export{qe as default};
