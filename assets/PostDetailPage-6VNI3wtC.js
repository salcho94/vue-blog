import{s as z,x as E,y as F,z as K,A as O,B as U,C as G,D as J,E as S,G as Q,d as W,H as X,I as Y,r as m,c as w,l as Z,w as M,o as ee,b as n,g as f,t as v,e as l,J as te,k as se,i as P,u as h,R as ae,F as D,h as L,f as le,v as oe,K as re,L as ne,M as ie,q as r,N as B,O as ue,P as de}from"./index-J_ORtUVl.js";import{M as ce}from"./index-BMSQkwth.js";const A=U(S,"comments");async function ve(x){await J(A,{...x,createdAt:Q()})}async function b(x){const u=F(A,O("postId","==",x),K("createdAt","asc"));return(await G(u)).docs.map(g=>({id:g.id,...g.data()}))}async function N(x){await z(E(S,"comments",x))}const me={class:"max-w-3xl mx-auto space-y-4"},xe={key:0,class:"text-xs text-slate-500"},pe={key:1,class:"text-xs text-red-400"},fe={key:2,class:"space-y-5"},ge={class:"flex items-center justify-between gap-3"},ye={class:"text-2xl font-semibold text-slate-900 dark:text-slate-100"},ke={class:"flex flex-wrap items-center gap-2 text-[11px] text-slate-500"},he=["disabled","title"],be={class:"text-xs"},_e={class:"prose prose-sm max-w-none dark:prose-invert text-slate-800 dark:text-slate-100 bg-slate-50 dark:bg-slate-900/90 rounded-2xl p-4"},we=["innerHTML"],Ce={key:0,class:"flex flex-wrap gap-2 mt-3"},Ie={class:"space-y-3"},Me={class:"text-sm font-medium text-slate-800 dark:text-slate-100 flex items-center gap-2"},Pe={class:"text-[10px] text-slate-500"},De={key:0,class:"flex gap-2 items-start"},Le={key:1,class:"text-[11px] text-slate-500"},Be={key:2,class:"space-y-1.5"},Ne={class:"space-y-0.5"},Se={class:"font-medium text-slate-700 dark:text-slate-300"},Ae={class:"text-slate-700 dark:text-slate-100"},Te=["onClick"],Ve={key:3,class:"text-[11px] text-slate-500"},$e=W({__name:"PostDetailPage",setup(x){const u=X(),C=Z(),g=ne(),o=Y(),t=m(null),i=m([]),_=m(!0),p=m(""),y=m(""),d=m(!1),k=m(!1),c=w(()=>C.params.id),T=new ce({breaks:!0}),V=w(()=>t.value?T.render(t.value.content):"");async function H(e){if(!e){p.value="잘못된 포스트 ID입니다.",t.value=null,i.value=[],d.value=!1;return}_.value=!0,p.value="";try{const a=await ue(e);if(!a){p.value="포스트를 찾을 수 없습니다.",t.value=null,i.value=[],d.value=!1;return}t.value=a;const s=`viewed_post_${e}`;sessionStorage.getItem(s)||de(e).then(()=>{sessionStorage.setItem(s,"1")}).catch(()=>{}),i.value=await b(e),o.user?d.value=await B(e,o.user.uid):d.value=!1}catch(a){p.value=a?.message||"불러오기 실패",t.value=null,i.value=[],d.value=!1}finally{_.value=!1}}M(c,e=>{e&&H(e)},{immediate:!0}),M(()=>o.user?.uid,async e=>{t.value&&(d.value=e?await B(c.value,e):!1)}),ee(()=>{o.init?.()});const I=w(()=>!!(o.user&&t.value&&o.user.uid===t.value.authorId));async function R(){if(!o.user){u.alert({title:"해당 댓글을 삭제할까요?",message:"삭제 후에는 되돌릴 수 없습니다.",type:"error",onConfirm:async()=>{try{await N(id),c.value&&(i.value=await b(c.value))}catch(a){u.alert({title:"댓글 삭제 실패",message:a?.message||"삭제 중 오류가 발생했습니다.",type:"error"})}}});return}const e=y.value.trim();if(!(!e||!c.value))try{await ve({postId:c.value,authorId:o.user.uid,authorName:o.user.email||"user",content:e}),y.value="",i.value=await b(c.value)}catch(a){alert(a?.message||"댓글 등록 실패")}}async function q(e,a){if(!(!o.user||o.user.uid!==a))try{u.confirm({title:"해당 댓글을 삭제할까요?",message:"삭제 후에는 되돌릴 수 없습니다.",type:"error",onConfirm:async()=>{try{await N(e),c.value&&(i.value=await b(c.value))}catch(s){u.alert({title:"댓글 삭제 실패",message:s?.message||"삭제 중 오류가 발생했습니다.",type:"error"})}}})}catch(s){alert(s?.message||"댓글 삭제 실패")}}async function $(){t.value&&u.confirm({title:"이 글을 삭제할까요?",message:"삭제 후에는 되돌릴 수 없습니다.",type:"error",onConfirm:async()=>{try{await re(t.value.id),g.push("/")}catch(e){u.alert({title:"삭제 실패",message:e?.message||"삭제 중 오류가 발생했습니다.",type:"error"})}}})}async function j(){if(t.value){if(!o.user){u.alert({title:"비회원",message:"로그인이 필요합니다!",type:"info"});return}if(!k.value){k.value=!0;try{const e=await ie(t.value.id,o.user.uid);d.value=e.liked,t.value&&(t.value.likes=e.likes)}catch(e){console.error(e),alert(e?.message||"좋아요 처리 중 오류가 발생했습니다.")}finally{k.value=!1}}}}return(e,a)=>(r(),n("div",me,[_.value?(r(),n("div",xe,"loading...")):p.value?(r(),n("div",pe,v(p.value),1)):t.value?(r(),n("div",fe,[l("div",ge,[l("h1",ye,v(t.value.title),1),l("div",ke,[l("span",null,v(t.value.views??0)+" views",1),l("button",{onClick:j,disabled:k.value,class:"inline-flex items-center gap-1 px-2 py-1 rounded-md border border-slate-300/80 dark:border-slate-600/80 bg-white/90 dark:bg-slate-900/80 hover:border-cyan-400 hover:text-cyan-300 disabled:opacity-60 disabled:cursor-not-allowed transition-colors",title:d.value?"좋아요 취소":"좋아요"},[l("span",be,v(d.value?"★":"☆"),1),l("span",null,v(t.value.likes??0),1)],8,he),I.value?(r(),te(h(ae),{key:0,to:`/admin/edit/${t.value.id}`,class:"px-2 py-1 rounded-md bg-slate-900 text-slate-100 hover:bg-black dark:bg-yellow-400 dark:text-black dark:hover:bg-yellow-300 transition-colors"},{default:se(()=>[...a[1]||(a[1]=[P(" 수정 ",-1)])]),_:1},8,["to"])):f("",!0),I.value?(r(),n("button",{key:1,onClick:$,class:"px-2 py-1 rounded-md bg-red-500 text-white hover:bg-red-400 transition-colors"}," 삭제 ")):f("",!0)])]),l("article",_e,[l("div",{innerHTML:V.value},null,8,we)]),t.value.tags&&t.value.tags.length?(r(),n("div",Ce,[(r(!0),n(D,null,L(t.value.tags,s=>(r(),n("span",{key:s,class:"px-2 py-1 rounded-md text-[11px] bg-slate-100 dark:bg-slate-900/70 text-slate-700 dark:text-slate-200 border border-transparent hover:border-black dark:hover:border-yellow-400 cursor-default select-none transition"}," #"+v(s),1))),128))])):f("",!0),l("section",Ie,[l("h2",Me,[a[2]||(a[2]=P(" comments ",-1)),l("span",Pe,"("+v(i.value.length)+")",1)]),h(o).user?(r(),n("div",De,[le(l("textarea",{"onUpdate:modelValue":a[0]||(a[0]=s=>y.value=s),rows:"2",class:"flex-1 rounded-md border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-950 px-2 py-1.5 text-[12px] text-slate-800 dark:text-slate-100 resize-none focus:outline-none focus:ring-1 focus:ring-black dark:focus:ring-yellow-400",placeholder:"댓글을 입력하세요"},null,512),[[oe,y.value]]),l("button",{onClick:R,class:"px-3 py-1.5 rounded-md text-[11px] font-semibold bg-black text-white hover:bg-slate-800 dark:bg-yellow-400 dark:text-black dark:hover:bg-yellow-300 transition-colors"}," 등록 ")])):(r(),n("div",Le," 댓글을 작성하려면 로그인하세요. ")),i.value.length?(r(),n("div",Be,[(r(!0),n(D,null,L(i.value,s=>(r(),n("div",{key:s.id,class:"flex items-start justify-between gap-2 rounded-md bg-slate-100 dark:bg-slate-900/80 px-2 py-1.5 text-[11px]"},[l("div",Ne,[l("div",Se,v(s.authorName||"user"),1),l("div",Ae,v(s.content),1)]),h(o).user&&h(o).user.uid===s.authorId?(r(),n("button",{key:0,onClick:He=>q(s.id,s.authorId),class:"mt-1 text-[10px] text-red-400 hover:text-red-300"}," 삭제 ",8,Te)):f("",!0)]))),128))])):(r(),n("div",Ve," 아직 댓글이 없습니다. "))])])):f("",!0)]))}});export{$e as default};
